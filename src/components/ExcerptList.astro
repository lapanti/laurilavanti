---
import type { Entry } from 'contentful'
import { contentfulClient } from '../lib/contentful'
import { CONTENT_PADDING, sizes } from '../lib/styles'
import type { Post } from '../types/contentful'
import Excerpt from './excerptList/Excerpt.astro'

const entries = await contentfulClient.getEntries<Post>({
    content_type: 'post',
    include: 1,
})

const { limit, allTags, currentSlug, tag, relatedTags } = Astro.props

const noCurrent = currentSlug ? entries.items.filter((item) => item.fields.slug !== currentSlug) : entries.items

const tagFiltered = tag ? noCurrent.filter((item) => item.metadata.tags.some((someTag) => someTag.sys.id === tag)) : noCurrent

const dateSorted = tagFiltered.toSorted((a, b) => (new Date(b.sys.createdAt)).valueOf() - (new Date(a.sys.createdAt)).valueOf())

const tagSorted = relatedTags ? dateSorted
                .reduce<[Entry<Post, undefined, undefined>, number][]>(
                    (acc, curr) => [
                        ...acc,
                        [
                            curr,
                            // 1 point per matching tag
                            relatedTags.reduce(
                                (pointsAcc, currentRelatedTag) =>
                                    pointsAcc +
                                    (curr.metadata.tags.map((someTag) => someTag.sys.id).includes(currentRelatedTag.sys.id)
                                        ? 1
                                        : 0),
                                0
                            ),
                        ],
                    ],
                    []
                )
                .toSorted((a, b) => {
                    // Higher points first
                    return a[1] < b[1] ? 1 : -1
                })
                .map((postWithPoints) => postWithPoints[0])
                : dateSorted

const nodes = limit ? tagSorted.slice(0, limit) : tagSorted
---
<style define:vars={{ contentPadding: CONTENT_PADDING, sizes2: sizes[2], sizes35: sizes[35], sizes3point5: sizes[3.5], sizes4: sizes[4] }}>
    ul {
        column-gap: var(--sizes4);
        display: grid;
        grid-column-start: 3;
        grid-template-columns: minmax(100%, var(--sizes35));
        grid-template-rows: auto;
        justify-content: center;
        justify-items: center;
        margin-left: var(--contentPadding);
        margin-right: var(--contentPadding);
        margin-top: var(--sizes2);
        row-gap: var(--sizes3point5);

        @media (min-width: 1200px) {
            grid-template-columns: repeat(2, var(--sizes35));
            margin-top: var(--sizes3point5);
        }
    }
</style>
<ul>
    {nodes.map((node) => (
        <Excerpt title={node.fields.title} excerpt={node.fields.excerpt} slug={`blogi/${node.fields.slug}`} image={node.fields.image} date={node.fields.publishDate || node.sys.createdAt} allTags={allTags} tags={node.metadata.tags} />
    ))}
</ul>
